FROM ubuntu:jammy

RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    sudo
WORKDIR /app
COPY requirements.txt .
RUN pip3 install -r requirements.txt
RUN pip3 install flask-sqlalchemy pymysql cryptography

ARG USERNAME=grimes
ARG PASSWORD=14mr1ckgr1m3showdy
ARG USER_UID=1000
ARG USER_GID=${USER_UID}

RUN groupadd --gid ${USER_GID} ${USERNAME} \
    && useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME} \
    && echo "${USERNAME}:${PASSWORD}" | chpasswd \
    && chmod 700 /home/${USERNAME}/ \
    && chown -R ${USERNAME}:${USERNAME} /home/${USERNAME} 
COPY ./sysadmin.sh /home/${USERNAME}/admin.sh
COPY flags/root.txt /root/root.txt
COPY flags/user.txt /home/${USERNAME}/user.txt

COPY ./app/ .
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
RUN echo "grimes ALL=(ALL) NOPASSWD: /home/grimes/admin.sh" >> /etc/sudoers \
    && chmod 755 /home/$USERNAME/admin.sh

EXPOSE 5000

USER grimes
CMD ["python3", "app.py"]
 