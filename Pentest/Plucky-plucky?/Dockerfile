FROM ubuntu:jammy

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y apache2 php php-fpm wget libapache2-mod-fcgid php-curl libcap2-bin \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

COPY ./root.txt /root/root.txt
COPY ./pluck /var/www/html/
COPY nissan_note.txt /home/

ARG USERNAME=lysiy
ARG PASSWORD=1_4m_th3_l1l_sp33p
ARG USER_UID=1000
ARG USER_GID=${USER_UID}

RUN groupadd --gid ${USER_GID} ${USERNAME} \
    && useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME} \
    && echo "${USERNAME}:${PASSWORD}" | chpasswd \
    && chmod 700 /home/${USERNAME}/ \
    && chown ${USERNAME}:${USERNAME} /home/${USERNAME} \
    && chown root:root /root/root.txt \
    && echo "ServerName localhost" >> /etc/apache2/apache2.conf \
    && a2enmod rewrite  \
    && rm /var/www/html/index.html \
    && chown -R www-data:www-data /var/www/html/ \
    && setcap cap_setuid+ep /usr/bin/php8.1

WORKDIR /var/www/html

EXPOSE 80

CMD ["apache2ctl", "-D", "FOREGROUND"]