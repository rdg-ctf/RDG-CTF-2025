FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    python3.8 \
    python3.8-dev \
    python3.8-distutils \
    python3-pip \
    gcc \
    wget \
    vim \
    netcat \
    build-essential \
    libssl-dev \
    libffi-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    libncurses5-dev \
    libgdbm-dev \
    libnss3-dev \
    liblzma-dev \
    supervisor \
    inotify-tools \
    && apt-get clean

RUN pip3 install --upgrade pip

RUN useradd -m -u 1000 -s /bin/bash ctfuser

ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

WORKDIR /app

COPY requirements.txt /app/
RUN pip3 install --no-cache-dir -r /app/requirements.txt

COPY main.py /app/
COPY exploit/exp.c /tmp/

RUN gcc -fno-stack-protector -z execstack -no-pie /tmp/exp.c -o /usr/local/bin/help_admin -pthread

RUN chown root:root /usr/local/bin/help_admin && chmod +s /usr/local/bin/help_admin

RUN mkdir -p /var/www/scripts && chown ctfuser:ctfuser /var/www/scripts && chmod 755 /var/www/scripts

RUN echo "RDG{73l36r4m_b075_c4n_4l50_b3_un54f3}" > /root/flag.txt

COPY file_exec.py /app/
RUN chown ctfuser:ctfuser /app/file_exec.py && chmod +x /app/file_exec.py

COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

USER root

CMD ["/usr/bin/supervisord"]
