FROM ubuntu:jammy

RUN apt-get update && \
    apt-get install -y software-properties-common && \
    add-apt-repository ppa:ondrej/php && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    apache2 \
    libapache2-mod-php7.0 \
    wget \
    php7.0 \
    php7.0-cli \
    php7.0-mbstring \
    sudo \
    netcat \
    python3 \
    djvulibre-bin \
    zip \
    make \
    perl && \
    rm -rf /var/lib/apt/lists/*

RUN a2enmod rewrite

RUN useradd -m -s /bin/bash dalton && \
    echo "dalton:asshole" | chpasswd && \
    mkdir -p /mnt/hgfs/share/delivery

COPY dalton /mnt/hgfs/share/delivery/dalton
COPY message /mnt/hgfs/share/delivery/message
COPY src/ /var/www/html/
COPY config/000-default.conf /etc/apache2/sites-available/000-default.conf
COPY config/php.ini /etc/php/7.0/apache2/conf.d/99-custom.ini

RUN chown -R www-data:www-data /var/www/html && \
    mkdir -p /var/log/phplogs && \
    chmod 733 /var/log/phplogs \
    chmod 644 /mnt/hgfs/share/delivery/dalton

RUN a2ensite 000-default.conf

WORKDIR /home/dalton
RUN wget https://github.com/exiftool/exiftool/archive/refs/tags/12.23.zip && \
    unzip 12.23.zip && \
    rm 12.23.zip

WORKDIR /home/dalton/exiftool-12.23
RUN perl Makefile.PL && \
    make test && \
    make install

WORKDIR /home/dalton/
RUN rm -rf exiftool-12.23

RUN echo "dalton ALL=(ALL) NOPASSWD: /usr/local/bin/exiftool" >> /etc/sudoers

RUN chown -R dalton:dalton /home/dalton

COPY flags/user.txt /home/dalton/user.txt
COPY flags/root.txt /root/root_6470e394cbf6dab6.txt

EXPOSE 80
WORKDIR /var/www/html
CMD ["/bin/bash", "-c", "apachectl configtest && service apache2 start && tail -F /var/log/apache2/error.log && rm -f /var/www/html/index.html"]